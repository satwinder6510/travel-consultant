<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Cruise Consultant v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .animate-bounce-dot { animation: bounce 1s infinite; }
    .animate-bounce-dot:nth-child(2) { animation-delay: 0.1s; }
    .animate-bounce-dot:nth-child(3) { animation-delay: 0.2s; }
  </style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-white min-h-screen">
  <div id="app" class="flex flex-col h-screen"></div>

  <script>
    // ========================================================================
    // CRUISE DATA - Loaded from JSON
    // ========================================================================
    let CRUISES = [];
    let SHIPS = [];
    let OPERATORS = [];
    let dataLoaded = false;

    async function loadCruiseData() {
      try {
        const [cruisesRes, shipsRes, operatorsRes] = await Promise.all([
          fetch('https://pub-484ab07ee6e74f0197c2acd5c8016f86.r2.dev/cruise-data-full.json'),
          fetch('cruise-data-ships-all.json'),
          fetch('cruise-data-operators.json')
        ]);
        CRUISES = await cruisesRes.json();
        SHIPS = await shipsRes.json();
        OPERATORS = await operatorsRes.json();
        dataLoaded = true;
        // Filter to future cruises with valid prices only
        const today = new Date().toISOString().split('T')[0];
        filteredCruises = CRUISES.filter(c =>
          c.start && c.start >= today &&
          hasValidPrice(c)
        );
        displayCruises = [...filteredCruises];
        console.log(`Loaded ${CRUISES.length} cruises, ${SHIPS.length} ships, ${OPERATORS.length} operators`);
        buildSystemPrompt();
        render();
      } catch (error) {
        console.error('Failed to load cruise data:', error);
        document.getElementById('app').innerHTML = `
          <div class="flex items-center justify-center h-screen">
            <div class="text-red-600 text-center">
              <p class="text-xl font-bold">Failed to load cruise data</p>
              <p class="text-sm mt-2">Check console for details</p>
            </div>
          </div>`;
      }
    }

    let SYSTEM_PROMPT = '';

    function buildSystemPrompt() {
      // Limit cruises for prompt size
      const cruiseList = CRUISES.slice(0, 100).map(c =>
        `‚Ä¢ ${c.ref}: "${c.name}" by ${c.operator} | ${c.region} | ${c.nights}N | ${c.start} | ${c.from}‚Üí${c.to} | ${c.rating} | ¬£${getBasePrice(c)}`
      ).join('\n');

      // Sample ships (mix of river and ocean)
      const sampleShips = SHIPS.slice(0, 50);
      const shipList = sampleShips.map(s =>
        `‚Ä¢ ${s.name}: ${s.operator} | ${s.capacity || '?'} guests | Built ${s.year || '?'} | ${s.type || ''}`
      ).join('\n');

      SYSTEM_PROMPT = `You are an expert cruise consultant for BOTH river and ocean cruises. Always recommend SPECIFIC cruises from the data below with actual prices and dates.

CRUISE INVENTORY (${CRUISES.length} total, showing sample):
${cruiseList}

SHIPS (${sampleShips.length} ships):
${shipList}

QUERY HANDLING:

1. DESTINATIONS/RIVERS - Match to region field:
   - Rhine: Castles, vineyards, Cologne, Amsterdam, Basel
   - Danube: Vienna, Budapest, Passau, cultural capitals
   - Douro: Portugal wine country, Porto, terraced vineyards
   - Rh√¥ne: Provence, Lyon, French cuisine, lavender

2. BEST TIME TO CRUISE - Match to start dates:
   - Spring (Apr-May): Tulips, mild weather
   - Summer (Jun-Aug): Peak season, family-friendly
   - Christmas Markets (Nov-Dec): Festive, magical
   - Shoulder (Sep-Oct): Wine harvest, fewer crowds

3. OPERATORS - Match to operator field:
   - A-ROSA: German, Premium, all-inclusive drinks
   - Viking: Scandinavian design, cultural focus, Premium
   - AmaWaterways: American, Luxury, top dining
   - Scenic: Australian, Luxury, all-inclusive
   - UNIWORLD: Boutique, Ultra Luxury, art-themed ships

4. LUXURY LEVELS - Match to rating field:
   - Premium (¬£950-1500): Quality, good value
   - Luxury (¬£2500-4000): All-inclusive, fine dining
   - Ultra Luxury (¬£4000+): Butler service, exclusive

5. BUDGET QUERIES - Sort/filter by price field:
   - "Budget" or "value": Show lowest prices first
   - "Luxury": Filter rating=Luxury or Ultra Luxury
   - Compare cabin types: inside‚Üíoutside‚Üíbalcony‚Üísuite

6. EXPERIENCES - Match cruise names and regions:
   - Wine: Douro, Moselle, Rhine vineyards
   - Christmas markets: Nov-Dec departures on Danube/Rhine
   - Cultural: Danube capitals, Viking itineraries
   - Scenic: Rhine castles, Douro valleys

7. PRACTICAL CONCERNS - Use your knowledge:
   - Accessibility: River ships have limited mobility access
   - Solo travel: Single supplements vary by operator
   - Family: Check ship policies, summer dates best
   - First-timers: Recommend Rhine or Danube, 7 nights

ALWAYS: Quote specific cruise ref, ship name, exact dates, and real prices. Never invent cruises.`;
    }

    // ========================================================================
    // APP STATE
    // ========================================================================
    let currentFilters = { query: '' };
    let filteredCruises = [];    // Full filtered list (for real count)
    let displayCruises = [];     // Cached results for cards (synced with prompt)
    let userTurns = 0;           // Track conversation depth
    let accumulatedFilters = new Set(); // Persists across conversation
    let currentOperatorFilter = '';  // Cruise line filter
    let currentDurationFilter = '';  // Duration filter

    let messages = [];
    let apiKey = localStorage.getItem('anthropic_api_key') || '';
    let isLoading = false;

    // Wizard state
    let wizardStep = 1;
    let wizardAnswers = {
      type: null,      // 'river' or 'ocean'
      region: null,    // destination
      travelers: null  // 1, 2, or '3+'
    };
    let wizardComplete = false;

    const REGIONS = {
      river: ['Danube', 'Rhine', 'Douro', 'Rh√¥ne', 'Seine', 'Mekong', 'Nile'],
      ocean: ['Caribbean', 'Mediterranean', 'Alaska', 'Northern Europe', 'Asia & Pacific', 'Australia & NZ']
    };

    function selectWizardOption(step, value) {
      if (step === 1) {
        wizardAnswers.type = value;
        wizardAnswers.region = null; // Reset region when type changes
        wizardStep = 2;
      } else if (step === 2) {
        wizardAnswers.region = value;
        wizardStep = 3;
      } else if (step === 3) {
        wizardAnswers.travelers = value;
        completeWizard();
      }
      render();
    }

    function goBackWizard() {
      if (wizardStep > 1) {
        wizardStep--;
        render();
      }
    }

    function completeWizard() {
      wizardComplete = true;
      currentOperatorFilter = '';
      currentDurationFilter = '';
      applyWizardFilters();
      // Sort by price initially
      displayCruises.sort((a, b) => getBasePrice(a) - getBasePrice(b));
      render();
      // Scroll to top of results
      setTimeout(() => {
        window.scrollTo(0, 0);
        const contentArea = document.querySelector('.overflow-y-auto');
        if (contentArea) contentArea.scrollTop = 0;
      }, 50);
    }

    function applyWizardFilters() {
      const today = new Date().toISOString().split('T')[0];
      filteredCruises = CRUISES.filter(c => {
        if (!c.start || c.start < today) return false;
        if (!hasValidPrice(c)) return false;

        // Type filter (infer from region if not set)
        if (wizardAnswers.type && getCruiseType(c) !== wizardAnswers.type) return false;

        // Region filter
        if (wizardAnswers.region) {
          const region = wizardAnswers.region.toLowerCase();
          const cruiseRegion = (c.region || '').toLowerCase();
          if (!cruiseRegion.includes(region) && !region.includes(cruiseRegion)) return false;
        }

        return true;
      });
      // Group by itinerary and show cheapest per group
      displayCruises = groupCruisesByItinerary(filteredCruises);
      console.log('Wizard filters applied:', wizardAnswers, '‚Üí', filteredCruises.length, 'sailings ‚Üí', displayCruises.length, 'itineraries');
    }

    function resetWizard() {
      wizardStep = 1;
      wizardAnswers = { type: null, region: null, travelers: null };
      wizardComplete = false;
      messages = [];
      userTurns = 0;
      accumulatedFilters.clear();
      currentOperatorFilter = '';
      currentDurationFilter = '';
      filteredCruises = CRUISES.filter(c =>
        c.start && c.start >= TODAY &&
        hasValidPrice(c)
      );
      displayCruises = [...filteredCruises];
      render();
    }

    function sortCruises(sortBy) {
      switch(sortBy) {
        case 'price-low':
          displayCruises.sort((a, b) => getBasePrice(a) - getBasePrice(b));
          break;
        case 'price-high':
          displayCruises.sort((a, b) => getBasePrice(b) - getBasePrice(a));
          break;
        case 'date':
          displayCruises.sort((a, b) => new Date(a.start) - new Date(b.start));
          break;
        case 'nights':
          displayCruises.sort((a, b) => a.nights - b.nights);
          break;
      }
      render();
    }

    function filterByOperator(operator) {
      currentOperatorFilter = operator;
      applyDisplayFilters();
    }

    function filterByDuration(duration) {
      currentDurationFilter = duration;
      applyDisplayFilters();
    }

    function applyDisplayFilters() {
      // Start with grouped cruises from wizard filters
      let results = groupCruisesByItinerary(filteredCruises);

      // Apply operator filter
      if (currentOperatorFilter) {
        results = results.filter(c => c.operator === currentOperatorFilter);
      }

      // Apply duration filter
      if (currentDurationFilter) {
        switch(currentDurationFilter) {
          case '1-5':
            results = results.filter(c => c.nights >= 1 && c.nights <= 5);
            break;
          case '6-9':
            results = results.filter(c => c.nights >= 6 && c.nights <= 9);
            break;
          case '10-14':
            results = results.filter(c => c.nights >= 10 && c.nights <= 14);
            break;
          case '15+':
            results = results.filter(c => c.nights >= 15);
            break;
        }
      }

      // Sort by price
      results.sort((a, b) => getBasePrice(a) - getBasePrice(b));

      displayCruises = results;
      render();
    }

    function clearAllFilters() {
      accumulatedFilters.clear();
      messages = [];
      applyWizardFilters(); // Re-apply just wizard filters
      render();
    }

    // River regions - used to infer cruise type from region
    const RIVER_REGIONS = ['danube', 'rhine', 'douro', 'rhone', 'seine', 'mekong', 'nile', 'moselle', 'main', 'elbe', 'loire', 'saone', 'garonne', 'ganges', 'yangtze', 'mississippi', 'amazon', 'chobe', 'zambezi', 'dutch waterways', 'magdalena', 'po', 'dordogne', 'gironde', 'guadalquivir', 'guadiana', 'oder'];

    // Get base price from cabins array (new data structure)
    function getBasePrice(cruise) {
      if (cruise.cabins && cruise.cabins.length > 0) {
        return parseFloat(cruise.cabins[0].price) || 0;
      }
      // Fallback for old data structure
      return parseFloat(cruise.price) || 0;
    }

    // Check if cruise has valid price
    function hasValidPrice(cruise) {
      return getBasePrice(cruise) > 0;
    }

    // Infer cruise type from region
    function getCruiseType(cruise) {
      if (cruise.type) return cruise.type; // Use if already set
      const region = (cruise.region || '').toLowerCase();
      return RIVER_REGIONS.some(r => region.includes(r)) ? 'river' : 'ocean';
    }

    // Get ship image by name
    function getShipImage(shipName) {
      if (!shipName || !SHIPS.length) return null;
      const ship = SHIPS.find(s => s.name && s.name.toLowerCase() === shipName.toLowerCase());
      return ship?.img || null;
    }

    // Group cruises by itinerary and get cheapest per group
    function groupCruisesByItinerary(cruises) {
      const groups = {};
      for (const c of cruises) {
        // Group key: operator + ship + cruise name
        const key = `${c.operator}|${c.ship}|${c.name}`;
        if (!groups[key]) {
          groups[key] = {
            ...c,
            sailingDates: 1,
            allDates: [c.start]
          };
        } else {
          groups[key].sailingDates++;
          groups[key].allDates.push(c.start);
          // Keep the cheapest
          if (getBasePrice(c) < getBasePrice(groups[key])) {
            const sailingDates = groups[key].sailingDates;
            const allDates = groups[key].allDates;
            groups[key] = { ...c, sailingDates, allDates };
          }
        }
      }
      return Object.values(groups);
    }

    // Get best cruise options - smart about single vs multiple operators
    function getBestCruises(cruises, limit = 5) {
      if (cruises.length === 0) return [];

      // Count operators in results
      const operators = new Set(cruises.map(c => c.operator));

      // If mostly one operator (>80% of results), show cheapest from that operator
      if (operators.size === 1 || cruises.length <= 10) {
        // Single operator or small set - just show cheapest overall
        return [...cruises]
          .sort((a, b) => getBasePrice(a) - getBasePrice(b))
          .slice(0, limit);
      }

      // Multiple operators - show cheapest per operator for variety
      const byOperator = {};
      for (const c of cruises) {
        const op = c.operator || 'Unknown';
        if (!byOperator[op] || getBasePrice(c) < getBasePrice(byOperator[op])) {
          byOperator[op] = c;
        }
      }
      return Object.values(byOperator)
        .sort((a, b) => getBasePrice(a) - getBasePrice(b))
        .slice(0, limit);
    }

    // Get smart header for cards section
    function getCardsHeader(cruises) {
      const operators = new Set(cruises.map(c => c.operator));
      if (operators.size === 1) {
        return `Best ${[...operators][0]} prices`;
      }
      return 'Best price per cruise line';
    }

    // ========================================================================
    // RENDER
    // ========================================================================
    function renderWizardModal() {
      const step1Class = wizardStep === 1 ? '' : 'hidden';
      const step2Class = wizardStep === 2 ? '' : 'hidden';
      const step3Class = wizardStep === 3 ? '' : 'hidden';

      const regions = wizardAnswers.type ? REGIONS[wizardAnswers.type] : [];

      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
          <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
            <!-- Progress bar -->
            <div class="h-1 bg-gray-200">
              <div class="h-1 bg-blue-600 transition-all duration-300" style="width: ${wizardStep * 33.33}%"></div>
            </div>

            <div class="p-6">
              <!-- Step 1: Type -->
              <div class="${step1Class}">
                <h2 class="text-xl font-bold text-gray-900 mb-2">What type of cruise?</h2>
                <p class="text-gray-500 text-sm mb-6">River cruises are intimate journeys along waterways. Ocean cruises explore seas and coastlines.</p>
                <div class="space-y-3">
                  <button onclick="selectWizardOption(1, 'river')"
                    class="w-full p-4 text-left border-2 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center gap-4">
                    <span class="text-3xl">üèûÔ∏è</span>
                    <div>
                      <div class="font-semibold text-gray-900">River Cruise</div>
                      <div class="text-sm text-gray-500">Danube, Rhine, Douro & more</div>
                    </div>
                  </button>
                  <button onclick="selectWizardOption(1, 'ocean')"
                    class="w-full p-4 text-left border-2 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center gap-4">
                    <span class="text-3xl">üö¢</span>
                    <div>
                      <div class="font-semibold text-gray-900">Ocean Cruise</div>
                      <div class="text-sm text-gray-500">Caribbean, Mediterranean, Alaska & more</div>
                    </div>
                  </button>
                </div>
              </div>

              <!-- Step 2: Region -->
              <div class="${step2Class}">
                <button onclick="goBackWizard()" class="text-blue-600 text-sm mb-4 hover:underline">‚Üê Back</button>
                <h2 class="text-xl font-bold text-gray-900 mb-2">Where do you want to go?</h2>
                <p class="text-gray-500 text-sm mb-6">Select your preferred destination.</p>
                <div class="grid grid-cols-2 gap-3">
                  ${regions.map(r => `
                    <button onclick="selectWizardOption(2, '${r}')"
                      class="p-3 text-left border-2 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all">
                      <div class="font-semibold text-gray-900">${r}</div>
                    </button>
                  `).join('')}
                </div>
              </div>

              <!-- Step 3: Travelers -->
              <div class="${step3Class}">
                <button onclick="goBackWizard()" class="text-blue-600 text-sm mb-4 hover:underline">‚Üê Back</button>
                <h2 class="text-xl font-bold text-gray-900 mb-2">How many travelers?</h2>
                <p class="text-gray-500 text-sm mb-6">This helps us show the right cabin options and prices.</p>
                <div class="space-y-3">
                  <button onclick="selectWizardOption(3, 1)"
                    class="w-full p-4 text-left border-2 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center gap-4">
                    <span class="text-2xl">üë§</span>
                    <div>
                      <div class="font-semibold text-gray-900">Solo</div>
                      <div class="text-sm text-gray-500">Traveling alone</div>
                    </div>
                  </button>
                  <button onclick="selectWizardOption(3, 2)"
                    class="w-full p-4 text-left border-2 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center gap-4">
                    <span class="text-2xl">üë´</span>
                    <div>
                      <div class="font-semibold text-gray-900">Couple</div>
                      <div class="text-sm text-gray-500">2 travelers</div>
                    </div>
                  </button>
                  <button onclick="selectWizardOption(3, '3+')"
                    class="w-full p-4 text-left border-2 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center gap-4">
                    <span class="text-2xl">üë®‚Äçüë©‚Äçüëß</span>
                    <div>
                      <div class="font-semibold text-gray-900">Family / Group</div>
                      <div class="text-sm text-gray-500">3 or more travelers</div>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function render() {
      const app = document.getElementById('app');

      if (!dataLoaded) {
        app.innerHTML = `
          <div class="flex items-center justify-center h-screen">
            <div class="text-blue-600 text-center">
              <div class="text-4xl mb-4">üö¢</div>
              <p class="text-xl font-bold">Loading cruise data...</p>
            </div>
          </div>`;
        return;
      }

      // Show wizard modal if not complete
      const wizardModal = !wizardComplete ? renderWizardModal() : '';

      app.innerHTML = `
        ${wizardModal}

        <!-- Header with progress -->
        <header class="bg-blue-900 text-white p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold">Cruise Consultant</h1>
              <p class="text-blue-200 text-sm">${wizardComplete ?
                `${wizardAnswers.type === 'river' ? 'üèûÔ∏è River' : 'üö¢ Ocean'} ¬∑ ${wizardAnswers.region} ¬∑ ${wizardAnswers.travelers === 1 ? 'Solo' : wizardAnswers.travelers === 2 ? 'Couple' : 'Group'}`
                : 'Find your perfect cruise'}</p>
            </div>
            <div class="text-right flex items-center gap-4">
              ${wizardComplete ? `<button onclick="resetWizard()" class="text-blue-200 text-sm hover:text-white">Start over</button>` : ''}
              <div>
                <div class="text-2xl font-bold">${filteredCruises.length.toLocaleString()}</div>
                <div class="text-xs text-blue-200">cruises</div>
              </div>
            </div>
          </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex-1 overflow-y-auto ${!wizardComplete ? 'opacity-30' : ''}">
          ${!wizardComplete ? '<p class="text-center text-gray-400 mt-20">Complete the wizard to start searching...</p>' : `

          <!-- Sort & Filter Bar -->
          <div class="bg-gray-50 border-b px-4 py-3 sticky top-0 z-10">
            <div class="max-w-5xl mx-auto flex flex-wrap items-center justify-between gap-3">
              <div class="text-sm text-gray-600">${displayCruises.length.toLocaleString()} itineraries (${filteredCruises.length.toLocaleString()} sailing dates)</div>
              <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-gray-500">Cruise Line:</span>
                  <select onchange="filterByOperator(this.value)" class="text-sm border rounded px-2 py-1">
                    <option value="">All Cruise Lines</option>
                    ${[...new Set(groupCruisesByItinerary(filteredCruises).map(c => c.operator))].sort().map(op =>
                      `<option value="${op}" ${currentOperatorFilter === op ? 'selected' : ''}>${op}</option>`
                    ).join('')}
                  </select>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-sm text-gray-500">Duration:</span>
                  <select onchange="filterByDuration(this.value)" class="text-sm border rounded px-2 py-1">
                    <option value="">All Durations</option>
                    <option value="1-5" ${currentDurationFilter === '1-5' ? 'selected' : ''}>1-5 nights</option>
                    <option value="6-9" ${currentDurationFilter === '6-9' ? 'selected' : ''}>6-9 nights</option>
                    <option value="10-14" ${currentDurationFilter === '10-14' ? 'selected' : ''}>10-14 nights</option>
                    <option value="15+" ${currentDurationFilter === '15+' ? 'selected' : ''}>15+ nights</option>
                  </select>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-sm text-gray-500">Sort:</span>
                  <select onchange="sortCruises(this.value)" class="text-sm border rounded px-2 py-1">
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="date">Departure Date</option>
                    <option value="nights">Duration</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Cruise Cards Grid -->
          <div class="p-4 bg-gray-100">
            <div class="max-w-5xl mx-auto space-y-4">
              ${displayCruises.slice(0, 20).map(c => `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                  <div class="flex flex-col md:flex-row">
                    <!-- Left: Ship Image -->
                    <div class="md:w-80 h-52 md:h-auto relative flex-shrink-0 bg-gray-200">
                      ${getShipImage(c.ship) ? `
                        <img src="${getShipImage(c.ship)}" alt="${c.ship}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-full h-full bg-gradient-to-br from-sky-200 via-blue-300 to-indigo-400 items-center justify-center hidden absolute inset-0">
                          <svg class="w-24 h-24 text-white/50" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19zM6 6h12v3.97L12 8 6 9.97V6z"/>
                          </svg>
                        </div>
                      ` : `
                        <div class="w-full h-full bg-gradient-to-br from-sky-200 via-blue-300 to-indigo-400 flex items-center justify-center">
                          <svg class="w-24 h-24 text-white/50" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19zM6 6h12v3.97L12 8 6 9.97V6z"/>
                          </svg>
                        </div>
                      `}
                      <!-- Operator Logo -->
                      <div class="absolute top-3 left-3 bg-white px-3 py-2 rounded shadow-md">
                        <span class="font-bold text-gray-800 text-sm">${c.operator}</span>
                      </div>
                      <!-- Cruise Type Badge -->
                      <div class="absolute top-3 right-3 bg-gray-900/80 text-white px-3 py-1 rounded text-xs font-medium">
                        ${getCruiseType(c) === 'ocean' ? 'Cruise Only' : 'River Cruise'}
                      </div>
                    </div>

                    <!-- Right: Details -->
                    <div class="flex-1 p-5">
                      <!-- Title -->
                      <h3 class="text-xl font-bold text-gray-900 mb-3">${c.region} : ${c.name || c.region}</h3>

                      <!-- Details Row -->
                      <div class="flex flex-wrap items-center gap-x-5 gap-y-2 text-sm text-gray-600 mb-4">
                        <span class="flex items-center gap-1.5">
                          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                          </svg>
                          ${c.ship}
                        </span>
                        <span class="flex items-center gap-1.5">
                          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                          </svg>
                          ${c.sailingDates > 1
                            ? `<span class="text-blue-600 font-medium">${c.sailingDates} Sailing Dates</span>`
                            : (c.start ? new Date(c.start).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'}) : 'TBC')}
                        </span>
                        <span class="flex items-center gap-1.5">
                          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                          </svg>
                          ${c.nights} nights
                        </span>
                        <span class="flex items-center gap-1.5">
                          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                          </svg>
                          ${c.from || 'TBC'}
                        </span>
                      </div>

                      <!-- Rating badge -->
                      ${c.rating ? `<span class="inline-block px-2 py-1 text-xs font-medium rounded ${
                        c.rating === 'Ultra Luxury' ? 'bg-purple-100 text-purple-800' :
                        c.rating === 'Luxury' ? 'bg-amber-100 text-amber-800' :
                        'bg-blue-100 text-blue-800'
                      }">${c.rating}</span>` : ''}
                    </div>

                    <!-- Pricing Panel -->
                    <div class="md:w-56 bg-gray-50 p-4 border-l flex flex-col justify-between">
                      <div>
                        <p class="text-xs text-gray-500 mb-3 font-medium">From:</p>
                        <div class="space-y-2">
                          ${(c.cabins || []).map((cab, i) => `
                            <div class="flex justify-between items-center gap-2">
                              <span class="text-xs text-gray-600 truncate" title="${cab.name}">${cab.name}</span>
                              <span class="${i === 0 ? 'text-base font-bold text-gray-900' : 'text-sm font-medium text-gray-700'}">¬£${parseFloat(cab.price).toLocaleString()}</span>
                            </div>
                          `).join('')}
                        </div>
                      </div>
                      <div class="mt-4 space-y-2">
                        <a href="#" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
                          View Itinerary
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </a>
                        <button class="w-full bg-rose-600 text-white py-2.5 px-4 rounded text-sm font-bold hover:bg-rose-700 transition-colors uppercase tracking-wide">
                          View More
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}

              ${displayCruises.length > 20 ? `
                <div class="text-center py-4">
                  <p class="text-gray-500 text-sm">Showing 20 of ${displayCruises.length.toLocaleString()} itineraries. Use the filter bar to narrow your search.</p>
                </div>
              ` : ''}
            </div>
          </div>
          `}
        </div>

        <!-- Chat Filter Bar -->
        ${wizardComplete ? `
        <div class="border-t bg-white p-3 shadow-lg">
          <div class="max-w-5xl mx-auto">
            <div class="flex gap-3 items-center">
              <div class="flex-1 relative">
                <input type="text" id="messageInput" placeholder="Filter: e.g. 'under ¬£2000', 'July', '7 nights', 'balcony cabin'..."
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pr-24"
                  onkeypress="if(event.key==='Enter')sendMessage()" ${isLoading ? 'disabled' : ''}>
                <button onclick="sendMessage()" ${isLoading ? 'disabled' : ''}
                  class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-1.5 bg-blue-600 text-white rounded font-medium hover:bg-blue-700 disabled:opacity-50 text-sm">
                  Filter
                </button>
              </div>
            </div>
            ${messages.length > 0 ? `
              <div class="mt-2 text-sm text-gray-500">
                Active filters: ${Array.from(accumulatedFilters).join(', ') || 'None'}
                <button onclick="clearAllFilters()" class="ml-2 text-red-500 hover:underline">Clear all</button>
              </div>
            ` : ''}
          </div>
        </div>
        ` : ''}
      `;

    }

    function saveApiKey() {
      apiKey = document.getElementById('apiKeyInput').value;
      localStorage.setItem('anthropic_api_key', apiKey);
      render();
    }

    // ========================================================================
    // SMART FILTERING - Extract criteria from user message
    // ========================================================================
    const TODAY = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

    function filterCruises(userMessage) {
      const msg = userMessage.toLowerCase();
      console.log('Filtering with:', msg);

      // Start with future cruises only, with valid prices
      let filtered = CRUISES.filter(c =>
        c.start && c.start >= TODAY &&
        hasValidPrice(c)
      );
      console.log('After date/price filter:', filtered.length);

      // Cruise type filter (river vs ocean)
      const oceanKeywords = [
        'ocean', 'caribbean', 'mediterranean', 'alaska', 'bahamas', 'hawaii', 'cruise ship',
        'ncl', 'norwegian', 'royal caribbean', 'msc', 'carnival', 'celebrity', 'princess',
        'holland america', 'cunard', 'p&o', 'costa', 'disney cruise', 'silversea'
      ];
      const riverKeywords = ['river', 'a-rosa', 'viking river', 'amawaterways', 'uniworld', 'avalon'];

      if (riverKeywords.some(k => msg.includes(k))) {
        filtered = filtered.filter(c => getCruiseType(c) === 'river');
        console.log('After river filter:', filtered.length);
      } else if (oceanKeywords.some(k => msg.includes(k))) {
        filtered = filtered.filter(c => getCruiseType(c) === 'ocean');
        console.log('After ocean filter:', filtered.length);
      }

      // Region filters (river + ocean)
      const regions = {
        // River regions
        'danube': 'Danube', 'vienna': 'Danube', 'budapest': 'Danube', 'passau': 'Danube',
        'rhine': 'Rhine', 'cologne': 'Rhine', 'basel': 'Rhine',
        'douro': 'Douro', 'porto': 'Douro',
        'rhone': 'Rhone', 'rh√¥ne': 'Rhone', 'lyon': 'Rhone', 'provence': 'Rhone',
        'seine': 'Seine', 'paris': 'Seine',
        'mekong': 'Mekong', 'vietnam': 'Mekong', 'cambodia': 'Mekong',
        'nile': 'Nile', 'egypt': 'Nile',
        // Ocean regions
        'caribbean': 'Caribbean', 'bahamas': 'Caribbean', 'jamaica': 'Caribbean',
        'mediterranean': 'Mediterranean', 'greek': 'Mediterranean', 'italy': 'Mediterranean', 'spain': 'Mediterranean', 'rome': 'Mediterranean', 'barcelona': 'Mediterranean', 'athens': 'Mediterranean',
        'alaska': 'Alaska',
        'northern europe': 'Northern Europe', 'norway': 'Northern Europe', 'scandinavia': 'Northern Europe', 'fjords': 'Northern Europe',
        'asia': 'Asia', 'japan': 'Asia', 'singapore': 'Asia',
        'pacific': 'Pacific', 'hawaii': 'Pacific',
        'south america': 'South America', 'brazil': 'South America',
        'australia': 'Australia & New Zealand', 'new zealand': 'Australia & New Zealand'
      };
      for (const [keyword, region] of Object.entries(regions)) {
        if (msg.includes(keyword)) {
          filtered = filtered.filter(c =>
            c.region && c.region.toLowerCase().includes(region.toLowerCase())
          );
          console.log('After region filter (' + region + '):', filtered.length);
          break;
        }
      }

      // Budget filters
      const budgetMatch = msg.match(/(?:under|below|max|budget|¬£|¬£)\s*(\d{3,5})/);
      if (budgetMatch) {
        const maxPrice = parseInt(budgetMatch[1]);
        filtered = filtered.filter(c => getBasePrice(c) <= maxPrice);
      }
      if (msg.includes('budget') || msg.includes('cheap') || msg.includes('value')) {
        filtered = filtered.sort((a, b) => getBasePrice(a) - getBasePrice(b));
      }

      // Luxury filters
      if (msg.includes('luxury') || msg.includes('high-end') || msg.includes('premium')) {
        if (msg.includes('ultra')) {
          filtered = filtered.filter(c => c.rating === 'Ultra Luxury');
        } else if (msg.includes('luxury')) {
          filtered = filtered.filter(c => c.rating === 'Luxury' || c.rating === 'Ultra Luxury');
        }
      }

      // Duration filters - handle specific ranges from filter buttons
      if (msg.includes('3-5 nights') || msg.includes('3-5 night')) {
        filtered = filtered.filter(c => c.nights >= 3 && c.nights <= 5);
        console.log('After 3-5 nights filter:', filtered.length);
      } else if (msg.includes('7 night')) {
        filtered = filtered.filter(c => c.nights >= 6 && c.nights <= 8);
        console.log('After 7 nights filter:', filtered.length);
      } else if (msg.includes('10-14 night')) {
        filtered = filtered.filter(c => c.nights >= 10 && c.nights <= 14);
        console.log('After 10-14 nights filter:', filtered.length);
      } else {
        // Fallback: try to parse a single number
        const nightsMatch = msg.match(/(\d+)\s*(?:night|day)/);
        if (nightsMatch) {
          const nights = parseInt(nightsMatch[1]);
          filtered = filtered.filter(c => Math.abs(c.nights - nights) <= 1);
          console.log('After ' + nights + ' nights filter:', filtered.length);
        }
      }
      if (msg.includes('week')) {
        filtered = filtered.filter(c => c.nights >= 6 && c.nights <= 8);
        console.log('After week filter:', filtered.length);
      }

      // Date/month filters
      const months = {
        'january': '01', 'february': '02', 'march': '03', 'april': '04',
        'may': '05', 'june': '06', 'july': '07', 'august': '08',
        'september': '09', 'october': '10', 'november': '11', 'december': '12',
        'spring': ['03','04','05'], 'summer': ['06','07','08'],
        'autumn': ['09','10','11'], 'fall': ['09','10','11'], 'winter': ['12','01','02'],
        'christmas': ['11','12']
      };
      for (const [keyword, monthVal] of Object.entries(months)) {
        if (msg.includes(keyword)) {
          if (Array.isArray(monthVal)) {
            filtered = filtered.filter(c => monthVal.some(m => c.start && c.start.includes(`-${m}-`)));
          } else {
            filtered = filtered.filter(c => c.start && c.start.includes(`-${monthVal}-`));
          }
          break;
        }
      }

      // Operator filters (check AFTER type filter to search within correct type)
      const operatorMap = {
        'ncl': 'Norwegian Cruise Line',
        'norwegian': 'Norwegian Cruise Line',
        'royal caribbean': 'Royal Caribbean',
        'rccl': 'Royal Caribbean',
        'msc': 'MSC Cruises',
        'carnival': 'Carnival',
        'celebrity': 'Celebrity',
        'princess': 'Princess',
        'holland': 'Holland America',
        'cunard': 'Cunard',
        'a-rosa': 'A-ROSA',
        'arosa': 'A-ROSA',
        'viking': 'Viking',
        'ama': 'AmaWaterways',
        'amawaterways': 'AmaWaterways',
        'scenic': 'Scenic',
        'uniworld': 'UNIWORLD',
        'tauck': 'Tauck'
      };
      for (const [keyword, operator] of Object.entries(operatorMap)) {
        if (msg.includes(keyword)) {
          filtered = filtered.filter(c => c.operator && c.operator.toLowerCase().includes(operator.toLowerCase()));
          break;
        }
      }

      // Return the FULL filtered list (don't slice here - let caller decide)
      return filtered;
    }

    // Get a diverse sample for the prompt (max 30)
    function getSampleCruises(filtered) {
      if (filtered.length === CRUISES.length) {
        // No filters - get diverse mix
        const sample = [];
        const operators = [...new Set(CRUISES.map(c => c.operator))];
        const perOperator = Math.ceil(30 / Math.min(operators.length, 15));
        for (const op of operators.slice(0, 15)) {
          const opCruises = CRUISES.filter(c => c.operator === op).slice(0, perOperator);
          sample.push(...opCruises);
          if (sample.length >= 30) break;
        }
        return sample.slice(0, 30);
      }
      return filtered.slice(0, 30);
    }

    function buildDynamicPrompt(userMessage) {
      // Use the already-filtered list (set in sendMessage)
      const totalMatches = filteredCruises.length;
      const sample = getSampleCruises(filteredCruises);

      // Count river vs ocean in full database
      const riverCount = CRUISES.filter(c => getCruiseType(c) === 'river').length;
      const oceanCount = CRUISES.filter(c => getCruiseType(c) === 'ocean').length;

      // Count types in ALL matches (not just sample)
      const matchRiver = filteredCruises.filter(c => getCruiseType(c) === 'river').length;
      const matchOcean = filteredCruises.filter(c => getCruiseType(c) === 'ocean').length;

      // Debug log
      console.log('Filter debug:', {
        query: userMessage,
        totalCruises: CRUISES.length,
        riverInDb: riverCount,
        oceanInDb: oceanCount,
        totalMatches: totalMatches,
        sampleSize: sample.length,
        matchRiver,
        matchOcean
      });

      const cruiseList = sample.map(c =>
        `‚Ä¢ ${c.ref}: "${c.name}" by ${c.operator} on ${c.ship} | ${c.region} | ${c.nights}N | ${c.start?.split('T')[0]} | ${c.from}‚Üí${c.to} | ${c.rating} | ¬£${getBasePrice(c)} | TYPE: ${getCruiseType(c)}`
      ).join('\n');

      // Get cheapest per cruise line for the prompt
      const bestCruises = getBestCruises(filteredCruises, 5);
      const operators = new Set(filteredCruises.map(c => c.operator));
      const isSingleOperator = operators.size === 1;
      const operatorName = isSingleOperator ? [...operators][0] : '';

      const cheapestList = bestCruises.map(c =>
        `‚Ä¢ ${isSingleOperator ? '' : c.operator + ': '}¬£${getBasePrice(c)} - ${c.ship} | ${c.region} | ${c.nights} nights | ${c.start?.split('T')[0]}`
      ).join('\n');

      // After 2 turns, stop asking questions and present results
      const presentResults = userTurns >= 2;

      return `You are a cruise consultant.

TODAY'S DATE: ${TODAY} - Only suggest dates from ${TODAY} onwards. NEVER mention 2025 - it's now 2026!

MATCHING CRUISES: ${totalMatches} ${isSingleOperator ? operatorName + ' ' : ''}cruises match

${isSingleOperator ? `BEST ${operatorName.toUpperCase()} OPTIONS:` : 'BEST PRICE PER CRUISE LINE:'}
${cheapestList}

${presentResults ? `
ACTION: Show the best options${isSingleOperator ? ' from ' + operatorName : ' from each cruise line'} AND mention the filter buttons.

RESPONSE FORMAT:
- "From ${totalMatches} ${isSingleOperator ? operatorName + ' ' : ''}matches, here are the best options:"
- List each cruise (ship, destination, nights, price, date) - one line each
- End with: "Use the filter buttons below to narrow by dates, duration, or budget."

Show results and point them to the filters.
` : `
ACTION: Acknowledge their search and point them to filter buttons.

RESPONSE FORMAT:
- "Great! I found ${totalMatches} [type] cruises matching your search."
- "Use the filter buttons below to narrow down by duration, dates, or budget - click as many as apply!"

Keep it to 2 sentences. Point them to the buttons. Do not list cruises yet.
`}`;
    }

    const API_URL = 'https://travel-consultant.satwinder-a59.workers.dev/';

    // Validate Claude's response against our database
    function validateResponse(responseText) {
      const issues = [];

      // Build sets of valid data for fast lookup
      const validRefs = new Set(CRUISES.map(c => c.ref));
      const validShips = new Set(CRUISES.map(c => c.ship?.toLowerCase()).filter(Boolean));
      const validOperators = new Set(CRUISES.map(c => c.operator?.toLowerCase()).filter(Boolean));
      const validCruiseNames = new Set(CRUISES.map(c => c.name?.toLowerCase()).filter(Boolean));

      // Check for ref codes in response - they should match our data
      const refPattern = /\b([A-Z]{2,}[A-Z0-9]{8,})\b/g;
      const mentionedRefs = responseText.match(refPattern) || [];
      const invalidRefs = mentionedRefs.filter(ref => !validRefs.has(ref));
      if (invalidRefs.length > 0) {
        issues.push(`Reference codes not found in database: ${invalidRefs.join(', ')}`);
      }

      // Check for ship names that look specific but don't exist
      const suspiciousShips = ['MS Botticelli', 'MS Bellini', 'SS Eternal', 'MS Roma'];
      for (const ship of suspiciousShips) {
        if (responseText.toLowerCase().includes(ship.toLowerCase()) && !validShips.has(ship.toLowerCase())) {
          issues.push(`Ship "${ship}" not found in database`);
        }
      }

      // Check if response mentions specific prices without ref codes (likely hallucinated)
      const hasPrices = /¬£\d{1,},?\d{3}/.test(responseText);
      const hasRefs = mentionedRefs.some(ref => validRefs.has(ref));
      if (hasPrices && !hasRefs && responseText.length > 500) {
        issues.push('Prices mentioned without valid cruise reference codes');
      }

      return {
        hasIssues: issues.length > 0,
        warning: issues.length > 0
          ? 'Some details may not be verified. Please confirm cruise availability before booking.'
          : '',
        details: issues
      };
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text || isLoading || !wizardComplete) return;

      // Add text to accumulated filters
      accumulatedFilters.add(text);
      input.value = '';

      // Build filter string: wizard base + accumulated refinements
      const wizardBase = `${wizardAnswers.type} ${wizardAnswers.region}`;
      const allFilters = wizardBase + ' ' + Array.from(accumulatedFilters).join(' ');
      filteredCruises = filterCruises(allFilters);
      // Group by itinerary and show cheapest per group
      displayCruises = groupCruisesByItinerary(filteredCruises);

      // Sort by price
      displayCruises.sort((a, b) => getBasePrice(a) - getBasePrice(b));

      console.log('Filtering with:', allFilters, '‚Üí', filteredCruises.length, 'sailings ‚Üí', displayCruises.length, 'itineraries');
      render();
    }

    // Show loading state, then load data
    render();
    loadCruiseData();
  </script>
</body>
</html>
