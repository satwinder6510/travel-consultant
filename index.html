<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>River Cruise Consultant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .animate-bounce-dot { animation: bounce 1s infinite; }
    .animate-bounce-dot:nth-child(2) { animation-delay: 0.1s; }
    .animate-bounce-dot:nth-child(3) { animation-delay: 0.2s; }
  </style>
</head>
<body class="bg-gradient-to-b from-blue-50 to-white min-h-screen">
  <div id="app" class="flex flex-col h-screen"></div>

  <script>
    // ========================================================================
    // CRUISE DATA - Loaded from JSON
    // ========================================================================
    let CRUISES = [];
    let SHIPS = [];
    let OPERATORS = [];
    let dataLoaded = false;

    async function loadCruiseData() {
      try {
        const [cruisesRes, shipsRes, operatorsRes] = await Promise.all([
          fetch('cruise-data-cruises.json'),
          fetch('cruise-data-ships.json'),
          fetch('cruise-data-operators.json')
        ]);
        CRUISES = await cruisesRes.json();
        SHIPS = await shipsRes.json();
        OPERATORS = await operatorsRes.json();
        dataLoaded = true;
        console.log(`Loaded ${CRUISES.length} cruises, ${SHIPS.length} ships, ${OPERATORS.length} operators`);
        buildSystemPrompt();
        render();
      } catch (error) {
        console.error('Failed to load cruise data:', error);
        document.getElementById('app').innerHTML = `
          <div class="flex items-center justify-center h-screen">
            <div class="text-red-600 text-center">
              <p class="text-xl font-bold">Failed to load cruise data</p>
              <p class="text-sm mt-2">Check console for details</p>
            </div>
          </div>`;
      }
    }

    let SYSTEM_PROMPT = '';

    function buildSystemPrompt() {
      // Limit cruises for prompt size
      const cruiseList = CRUISES.slice(0, 100).map(c =>
        `‚Ä¢ ${c.ref}: "${c.name}" by ${c.operator} | ${c.region} | ${c.nights}N | ${c.start} | ${c.from}‚Üí${c.to} | ${c.rating} | ¬£${c.price}`
      ).join('\n');

      // River ships only with key stats
      const riverShips = SHIPS.filter(s => s.type === 'river').slice(0, 50);
      const shipList = riverShips.map(s =>
        `‚Ä¢ ${s.name}: ${s.operator} | ${s.capacity || '?'} guests | Built ${s.year || '?'} | ${s.size || ''}`
      ).join('\n');

      SYSTEM_PROMPT = `You are an expert river cruise consultant with real cruise inventory. Always recommend SPECIFIC cruises from the data below with actual prices and dates.

CRUISE INVENTORY (${CRUISES.length} total, showing sample):
${cruiseList}

SHIPS (${riverShips.length} river ships):
${shipList}

QUERY HANDLING:

1. DESTINATIONS/RIVERS - Match to region field:
   - Rhine: Castles, vineyards, Cologne, Amsterdam, Basel
   - Danube: Vienna, Budapest, Passau, cultural capitals
   - Douro: Portugal wine country, Porto, terraced vineyards
   - Rh√¥ne: Provence, Lyon, French cuisine, lavender

2. BEST TIME TO CRUISE - Match to start dates:
   - Spring (Apr-May): Tulips, mild weather
   - Summer (Jun-Aug): Peak season, family-friendly
   - Christmas Markets (Nov-Dec): Festive, magical
   - Shoulder (Sep-Oct): Wine harvest, fewer crowds

3. OPERATORS - Match to operator field:
   - A-ROSA: German, Premium, all-inclusive drinks
   - Viking: Scandinavian design, cultural focus, Premium
   - AmaWaterways: American, Luxury, top dining
   - Scenic: Australian, Luxury, all-inclusive
   - UNIWORLD: Boutique, Ultra Luxury, art-themed ships

4. LUXURY LEVELS - Match to rating field:
   - Premium (¬£950-1500): Quality, good value
   - Luxury (¬£2500-4000): All-inclusive, fine dining
   - Ultra Luxury (¬£4000+): Butler service, exclusive

5. BUDGET QUERIES - Sort/filter by price field:
   - "Budget" or "value": Show lowest prices first
   - "Luxury": Filter rating=Luxury or Ultra Luxury
   - Compare cabin types: inside‚Üíoutside‚Üíbalcony‚Üísuite

6. EXPERIENCES - Match cruise names and regions:
   - Wine: Douro, Moselle, Rhine vineyards
   - Christmas markets: Nov-Dec departures on Danube/Rhine
   - Cultural: Danube capitals, Viking itineraries
   - Scenic: Rhine castles, Douro valleys

7. PRACTICAL CONCERNS - Use your knowledge:
   - Accessibility: River ships have limited mobility access
   - Solo travel: Single supplements vary by operator
   - Family: Check ship policies, summer dates best
   - First-timers: Recommend Rhine or Danube, 7 nights

ALWAYS: Quote specific cruise ref, ship name, exact dates, and real prices. Never invent cruises.`;
    }

    // ========================================================================
    // APP STATE
    // ========================================================================
    let messages = [
      { role: 'assistant', content: `Hello! I'm your river cruise specialist. I can help you find the perfect European river cruise.

**Tell me about your ideal trip:**
‚Ä¢ When are you hoping to travel?
‚Ä¢ Who's joining you?
‚Ä¢ Any rivers catching your eye? (Danube, Rhine, Douro, Rh√¥ne)` }
    ];
    let apiKey = localStorage.getItem('anthropic_api_key') || '';
    let isLoading = false;

    // ========================================================================
    // RENDER
    // ========================================================================
    function render() {
      const app = document.getElementById('app');

      if (!dataLoaded) {
        app.innerHTML = `
          <div class="flex items-center justify-center h-screen">
            <div class="text-blue-600 text-center">
              <div class="text-4xl mb-4">üö¢</div>
              <p class="text-xl font-bold">Loading cruise data...</p>
            </div>
          </div>`;
        return;
      }

      app.innerHTML = `
        <!-- Header -->
        <header class="bg-blue-900 text-white p-4 shadow-lg">
          <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div>
              <h1 class="text-2xl font-bold">üö¢ River Cruise Consultant</h1>
              <p class="text-blue-200 text-sm">Find your perfect European river cruise</p>
            </div>
            <div class="text-right text-sm text-blue-200">
              <div>${CRUISES.length} cruises</div>
              <div>${SHIPS.filter(s => s.type === 'river').length} ships</div>
            </div>
          </div>
        </header>

        <!-- API Key -->
        <div class="bg-yellow-50 border-b border-yellow-200 p-3 ${apiKey ? 'hidden' : ''}">
          <div class="max-w-4xl mx-auto flex items-center gap-3">
            <span class="text-sm text-yellow-800">üîë Anthropic API Key:</span>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-..."
              class="flex-1 px-3 py-1 border rounded text-sm" value="${apiKey}">
            <button onclick="saveApiKey()" class="px-3 py-1 bg-yellow-600 text-white rounded text-sm hover:bg-yellow-700">
              Save
            </button>
          </div>
        </div>

        <!-- Messages -->
        <div class="flex-1 overflow-y-auto p-4">
          <div class="max-w-4xl mx-auto space-y-4">
            ${messages.map(m => `
              <div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}">
                <div class="max-w-[80%] rounded-2xl px-4 py-3 ${
                  m.role === 'user'
                    ? 'bg-blue-600 text-white rounded-br-md'
                    : 'bg-white shadow-md border border-gray-100 rounded-bl-md'
                }">
                  <div class="whitespace-pre-wrap text-sm leading-relaxed">${m.content}</div>
                </div>
              </div>
            `).join('')}
            ${isLoading ? `
              <div class="flex justify-start">
                <div class="bg-white shadow-md rounded-2xl px-4 py-3">
                  <div class="flex gap-1 text-gray-400">
                    <span class="animate-bounce-dot">‚óè</span>
                    <span class="animate-bounce-dot">‚óè</span>
                    <span class="animate-bounce-dot">‚óè</span>
                  </div>
                </div>
              </div>
            ` : ''}
          </div>
        </div>

        <!-- Input -->
        <div class="border-t bg-white p-4">
          <div class="max-w-4xl mx-auto flex gap-3">
            <input type="text" id="messageInput" placeholder="Tell me about your dream cruise..."
              class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeypress="if(event.key==='Enter')sendMessage()" ${isLoading ? 'disabled' : ''}>
            <button onclick="sendMessage()" ${isLoading ? 'disabled' : ''}
              class="px-6 py-3 bg-blue-600 text-white rounded-full font-medium hover:bg-blue-700 disabled:opacity-50">
              Send
            </button>
          </div>
          <div class="max-w-4xl mx-auto mt-2 flex gap-2 flex-wrap">
            ${['Rhine cruise', 'Danube in summer', 'Luxury options', 'Budget under ¬£1500'].map(s => `
              <button onclick="document.getElementById('messageInput').value='${s}'"
                class="px-3 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-full text-gray-600">
                ${s}
              </button>
            `).join('')}
          </div>
        </div>
      `;

      // Scroll to bottom
      const messagesDiv = document.querySelector('.overflow-y-auto');
      if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function saveApiKey() {
      apiKey = document.getElementById('apiKeyInput').value;
      localStorage.setItem('anthropic_api_key', apiKey);
      render();
    }

    // ========================================================================
    // SMART FILTERING - Extract criteria from user message
    // ========================================================================
    function filterCruises(userMessage) {
      const msg = userMessage.toLowerCase();
      let filtered = [...CRUISES];

      // Region filters
      const regions = {
        'danube': 'Danube', 'vienna': 'Danube', 'budapest': 'Danube', 'passau': 'Danube',
        'rhine': 'Rhine', 'cologne': 'Rhine', 'amsterdam': 'Rhine', 'basel': 'Rhine',
        'douro': 'Douro', 'porto': 'Douro', 'portugal': 'Douro',
        'rhone': 'Rhone', 'rh√¥ne': 'Rhone', 'lyon': 'Rhone', 'provence': 'Rhone'
      };
      for (const [keyword, region] of Object.entries(regions)) {
        if (msg.includes(keyword)) {
          filtered = filtered.filter(c => c.region === region);
          break;
        }
      }

      // Budget filters
      const budgetMatch = msg.match(/(?:under|below|max|budget|¬£|¬£)\s*(\d{3,5})/);
      if (budgetMatch) {
        const maxPrice = parseInt(budgetMatch[1]);
        filtered = filtered.filter(c => parseFloat(c.price) <= maxPrice);
      }
      if (msg.includes('budget') || msg.includes('cheap') || msg.includes('value')) {
        filtered = filtered.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
      }

      // Luxury filters
      if (msg.includes('luxury') || msg.includes('high-end') || msg.includes('premium')) {
        if (msg.includes('ultra')) {
          filtered = filtered.filter(c => c.rating === 'Ultra Luxury');
        } else if (msg.includes('luxury')) {
          filtered = filtered.filter(c => c.rating === 'Luxury' || c.rating === 'Ultra Luxury');
        }
      }

      // Duration filters
      const nightsMatch = msg.match(/(\d+)\s*(?:night|day|week)/);
      if (nightsMatch) {
        const nights = parseInt(nightsMatch[1]);
        if (msg.includes('week')) {
          filtered = filtered.filter(c => c.nights >= 6 && c.nights <= 8);
        } else {
          filtered = filtered.filter(c => Math.abs(c.nights - nights) <= 1);
        }
      }

      // Date/month filters
      const months = {
        'january': '01', 'february': '02', 'march': '03', 'april': '04',
        'may': '05', 'june': '06', 'july': '07', 'august': '08',
        'september': '09', 'october': '10', 'november': '11', 'december': '12',
        'spring': ['03','04','05'], 'summer': ['06','07','08'],
        'autumn': ['09','10','11'], 'fall': ['09','10','11'], 'winter': ['12','01','02'],
        'christmas': ['11','12']
      };
      for (const [keyword, monthVal] of Object.entries(months)) {
        if (msg.includes(keyword)) {
          if (Array.isArray(monthVal)) {
            filtered = filtered.filter(c => monthVal.some(m => c.start && c.start.includes(`-${m}-`)));
          } else {
            filtered = filtered.filter(c => c.start && c.start.includes(`-${monthVal}-`));
          }
          break;
        }
      }

      // Operator filters
      const operators = ['a-rosa', 'arosa', 'viking', 'ama', 'amawaterways', 'scenic', 'uniworld', 'tauck'];
      for (const op of operators) {
        if (msg.includes(op)) {
          filtered = filtered.filter(c => c.operator && c.operator.toLowerCase().includes(op.replace('-', '')));
          break;
        }
      }

      // Return top 30 matches (limit for prompt size)
      return filtered.slice(0, 30);
    }

    function buildDynamicPrompt(userMessage) {
      const matches = filterCruises(userMessage);
      const matchCount = matches.length;

      const cruiseList = matches.map(c =>
        `‚Ä¢ ${c.ref}: "${c.name}" by ${c.operator} on ${c.ship} | ${c.region} | ${c.nights}N | ${c.start?.split('T')[0]} | ${c.from}‚Üí${c.to} | ${c.rating} | ¬£${c.price} (balcony: ¬£${c.balcony || 'N/A'})`
      ).join('\n');

      return `You are an expert river cruise consultant. Recommend SPECIFIC cruises from the matches below.

MATCHING CRUISES (${matchCount} found from ${CRUISES.length} total):
${cruiseList || '(No exact matches - suggest alternatives from general knowledge)'}

INSTRUCTIONS:
- Quote specific cruise names, dates, prices, and ship names
- If few matches, explain why and suggest adjusting criteria
- Ask follow-up questions to refine: dates, budget, cabin type, group size
- Be concise but helpful`;
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      if (!text || isLoading) return;
      if (!apiKey) { alert('Please enter your API key'); return; }

      messages.push({ role: 'user', content: text });
      input.value = '';
      isLoading = true;
      render();

      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-3-haiku-20240307',
            max_tokens: 1024,
            system: buildDynamicPrompt(text),
            messages: messages.map(m => ({ role: m.role, content: m.content }))
          })
        });

        const data = await response.json();
        console.log('API Response:', data);
        if (!response.ok || data.error) {
          const errMsg = data.error?.message || data.message || JSON.stringify(data);
          messages.push({ role: 'assistant', content: `API Error (${response.status}): ${errMsg}` });
        } else if (data.content && data.content[0]) {
          messages.push({ role: 'assistant', content: data.content[0].text });
        } else {
          messages.push({ role: 'assistant', content: 'Unexpected response format. Check console for details.' });
        }
      } catch (error) {
        console.error('Fetch error:', error);
        messages.push({ role: 'assistant', content: `Connection error: ${error.message}` });
      }

      isLoading = false;
      render();
    }

    // Show loading state, then load data
    render();
    loadCruiseData();
  </script>
</body>
</html>
